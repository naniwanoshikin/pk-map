<%# Home メイン %>
<h2>周辺スポット</h2>
<div id='map'></div>
<style>
  #map {
    height: 350px;
    border-radius: 10px;
  }
</style>

<script>

  let map

  // 初期画面: User情報
  function initMap(){
    // 地図
    const target = document.getElementById('map')
    // オブジェクト生成
    geocoder = new google.maps.Geocoder()

    // 現在のユーザーの住所
    let user_address = {
      lat: <%= current_user.latitude %>, // 緯度
      lng: <%= current_user.longitude %>  // 経度
    }
    // 中心位置を表示
    map = new google.maps.Map(target, {
      center: user_address,
      zoom: 13,
      mapTypeControl: false, // 地図|写真
      streetViewControl: false, // ストリートビューマーク
      // mapTypeId: 'roadmap' // 地図の種類
      styles: [{
        // 全てのラベルを非表示
        // featureType: 'all',
        // elementType: 'labels',
        // stylers: [
        //   {visibility: 'off'},
        // ],
      }],
      icon: {
        url: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
        // サイズ
        scaledSize: new google.maps.Size(40, 40)
      }
    });
    // 自身のピンをさす
    marker = new google.maps.Marker({
      map: map,
      position: user_address
    });

    // 投稿一覧
    gon.posts.forEach(post => {
      // ピンをさす: 繰り返しなので let 入れないとエラー
      let marker = new google.maps.Marker({
        map: map,
        position: {
          // 高精度な位置情報がないとここでエラー
          lat: post.latitude,
          lng: post.longitude
        },
        // title: contentString
      });
      // 情報ウィンドウ(吹き出し)
      let infowindow = new google.maps.InfoWindow({
        content: `<a href='/posts/${post.id}'>${post.address}</a>`
      });
      // リンク表示
      marker.addListener('click', function() {
        infowindow.open(map, marker);
      });
      // marker.addListener('mouseout', function(){
      //   infowin.close();
      // });
    });
  }

</script>

<%# 検索 %>
<%= javascript_pack_tag 'map.js' %>

<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAP_API'] %>&callback=initMap" async defer></script>
